<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バーコード検品システム（ZXing版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont;
    text-align: center;
    padding: 20px;
}
#preview {
    width: 90%;
    border: 3px solid #4CAF50;
    border-radius: 10px;
}
#result, #status {
    font-size: 22px;
    margin-top: 15px;
}
button {
    padding: 12px 24px;
    font-size: 20px;
    margin-top: 20px;
    border-radius: 10px;
}
</style>

<!-- ZXing WebAssembly版 CDN -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

</head>
<body>

<h2>バーコード検品システム</h2>

<video id="preview"></video>

<div id="status">7桁バーコードを読み取ってください</div>
<div id="result"></div>

<button id="startBtn">カメラを起動</button>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
let step = 1; // 1 = 7桁, 2 = 10桁
let firstCode = "";

document.getElementById("startBtn").addEventListener("click", () => {
    startCamera();
});

async function startCamera() {
    document.getElementById("result").innerText = "";

    try {
        const videoInputDevices = await codeReader.listVideoInputDevices();

        // 背面カメラを選択
        const backCam = videoInputDevices.find(d => d.label.toLowerCase().includes("back"))
                     || videoInputDevices[0];

        await codeReader.decodeFromVideoDevice(backCam.deviceId, 'preview', (result, err) => {
            if (result) {
                const code = result.getText();

                if (step === 1 && code.length === 7) {
                    firstCode = code;
                    step = 2;
                    document.getElementById("status").innerText = "次に10桁バーコードを読み取ってください";
                    document.getElementById("result").innerText = "1つ目（7桁）: " + code;
                } 
                else if (step === 2 && code.length === 10) {
                    const first7 = code.substring(0, 7);

                    if (first7 === firstCode) {
                        document.getElementById("result").innerHTML =
                            `<span style="color:green;font-weight:bold;">✔ 一致しました！</span><br>2つ目: ${code}`;
                    } else {
                        document.getElementById("result").innerHTML =
                            `<span style="color:red;font-weight:bold;">✖ 一致しません！</span><br>2つ目: ${code}`;
                    }

                    // 初期化
                    step = 1;
                    firstCode = "";
                    document.getElementById("status").innerText = "7桁バーコードを読み取ってください";
                }
            }
        });
    } catch (e) {
        console.error(e);
        alert("カメラが起動できませんでした：" + e);
    }
}
</script>

</body>
</html>
